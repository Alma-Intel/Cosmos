{% extends 'base.html' %}

{% block title %}Conversations - CRM{% endblock %}

{% block content %}
<div class="filter-section">
    <form method="get" class="filter-form">
        <div class="form-group">
            <label for="seller_id">Seller ID</label>
            <select name="seller_id" id="seller_id">
                <option value="">All Sellers</option>
                {% for seller in all_sellers %}
                <option value="{{ seller.uuid }}" {% if seller.uuid == current_seller_id %}selected{% endif %}>
                    {{ seller.display }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="sales_stage">Sales Stage</label>
            <select name="sales_stage" id="sales_stage">
                <option value="">All Stages</option>
                {% for stage in all_sales_stages %}
                <option value="{{ stage }}" {% if stage == current_sales_stage %}selected{% endif %}>
                    {{ stage }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="tag">Tag</label>
            <select name="tag" id="tag">
                <option value="">All Tags</option>
                {% for tag in all_tags %}
                <option value="{{ tag }}" {% if tag == current_tag %}selected{% endif %}>
                    {{ tag }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="search">Search</label>
            <input type="text" name="search" id="search" placeholder="Name, Email, or Chat ID" value="{{ current_search }}">
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="{% url 'conversation_list' %}" class="btn btn-secondary" style="margin-top: 0.5rem; display: block; text-align: center; text-decoration: none;">Clear</a>
        </div>
    </form>
</div>

<div class="content">
    <h2 style="margin-bottom: 1.5rem; color: #333;">Conversations ({{ all_conversations_count }} total)</h2>
    
    {% if conversations %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 1rem; text-align: left; font-weight: 600;">Chat ID</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600;">Client Name</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600;">Email</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600;">Messages</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600;">Sellers</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600;">Last Update</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for conv in conversations %}
            <tr style="border-bottom: 1px solid #dee2e6;">
                <td style="padding: 1rem;">
                    <code style="background: #f8f9fa; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.85rem;">
                        {{ conv.chatId|truncatechars:20 }}
                    </code>
                </td>
                <td style="padding: 1rem;">{{ conv.metadata.clientName|default:"—" }}</td>
                <td style="padding: 1rem;">{{ conv.metadata.clientEmail|default:"—" }}</td>
                <td style="padding: 1rem;">{{ conv.mensagens|length }}</td>
                <td style="padding: 1rem;">
                    {% if conv.envolvedSellersDisplay %}
                        {% for seller in conv.envolvedSellersDisplay|slice:":2" %}
                            <span style="background: #e7f3ff; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.85rem; margin-right: 0.25rem;">
                                {{ seller|truncatechars:30 }}
                            </span>
                        {% endfor %}
                        {% if conv.envolvedSellersDisplay|length > 2 %}
                            <span style="color: #666; font-size: 0.85rem;">+{{ conv.envolvedSellersDisplay|length|add:"-2" }}</span>
                        {% endif %}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td style="padding: 1rem;">{{ conv.lastUpdate|date:"Y-m-d H:i" }}</td>
                <td style="padding: 1rem;">
                    <a href="{% url 'conversation_detail' conv.id %}" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
                        View Details
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if has_previous %}
            <a href="?page=1{% if current_seller_id %}&seller_id={{ current_seller_id }}{% endif %}{% if current_sales_stage %}&sales_stage={{ current_sales_stage }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}">&laquo; First</a>
            <a href="?page={{ previous_page }}{% if current_seller_id %}&seller_id={{ current_seller_id }}{% endif %}{% if current_sales_stage %}&sales_stage={{ current_sales_stage }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}">Previous</a>
        {% endif %}
        
        <span class="current">
            Page {{ current_page }} of {{ total_pages }}
        </span>
        
        {% if has_next %}
            <a href="?page={{ next_page }}{% if current_seller_id %}&seller_id={{ current_seller_id }}{% endif %}{% if current_sales_stage %}&sales_stage={{ current_sales_stage }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}">Next</a>
            <a href="?page={{ total_pages }}{% if current_seller_id %}&seller_id={{ current_seller_id }}{% endif %}{% if current_sales_stage %}&sales_stage={{ current_sales_stage }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}">Last &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
    
    {% else %}
    <p style="padding: 2rem; text-align: center; color: #666;">No conversations found.</p>
    {% endif %}
    
    {% if debug_info %}
    <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; font-size: 0.85rem;">
        <strong>Debug Info:</strong><br>
        Database: {{ debug_info.db_name }}<br>
        Collection: {{ debug_info.collection_name }}<br>
        Total matching documents: {{ debug_info.total_count }}<br>
        Conversations list length: {{ debug_info.conversations_list_length }}<br>
        Page object list length: {{ debug_info.page_obj_count }}<br>
        Query: <code>{{ debug_info.query }}</code>
    </div>
    {% endif %}
</div>
{% endblock %}

